name: Continuous Deployment (CD)

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    name: Test and Deploy to Heroku
    runs-on: ubuntu-22.04
    environment:
      name: Production
      url: https://a-rafa-rally-soelistiono-modul-81845caf2692.herokuapp.com

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Set up Java 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "21"
          cache: gradle

      - name: Make gradlew executable
        run: chmod +x ./gradlew

      - name: Run tests
        run: ./gradlew test

      - name: Deploy to Heroku
        uses: akhileshns/heroku-deploy@v3.14.15
        with:
          heroku_api_key: ${{ secrets.HEROKU_API_KEY }}
          heroku_app_name: ${{ secrets.HEROKU_APP_NAME }}
          heroku_email: ${{ secrets.HEROKU_EMAIL }}
          usedocker: false
          dontautocreate: true

      - name: Verify up page
        env:
          APP_URL: https://a-rafa-rally-soelistiono-modul-81845caf2692.herokuapp.com
        run: |
          for i in {1..18}; do
            response=$(curl -sSL --max-time 20 -w $'\n__STATUS__:%{http_code}' "$APP_URL/" || true)
            body=$(echo "$response" | sed '$d')
            status=$(echo "$response" | tail -n1 | sed 's/__STATUS__://')

            if [ "$status" = "200" ] \
              && echo "$body" | grep -qi "Welcome" \
              && echo "$body" | grep -qi "View Products"; then
              echo "Home page passed."
              exit 0
            fi

            echo "Attempt $i failed: status=$status. Waiting..."
            sleep 10
          done
          echo "Home page verification failed."
          exit 1

      - name: Publish deploy link
        run: |
          echo "### Deployment URL" >> $GITHUB_STEP_SUMMARY
          echo "https://a-rafa-rally-soelistiono-modul-81845caf2692.herokuapp.com" >> $GITHUB_STEP_SUMMARY
